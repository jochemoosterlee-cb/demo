<!DOCTYPE html>
<html lang="en" class="overflow-x-hidden">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <link rel="manifest" href="manifest.json">
  <link rel="icon" type="image/x-icon" href="favicon.ico">
  <link href="https://fonts.googleapis.com/css2?family=Headland+One&family=Inter:ital,wght@0,100;0,200;0,300;0,400;0,500;0,600;0,700;0,800;0,900;1,100;1,200;1,300;1,400;1,500;1,600;1,700;1,800;1,900&display=swap" rel="stylesheet" />
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="./html5-qrcode.min.js"></script>

  <script>
    tailwind.config = {
      theme: {
        extend: {
          fontFamily: {
            inter: ['Inter', 'sans-serif'],
            headland: ['"Headland One"', 'serif'],
          },
          colors: {
            brandBg: '#FAF5EB',
            textDark: '#222',
            cardBg: '#F7EFDD',
            brandBlue: '#163563',
            brandBlueHover: '#003d8c',
          },
        },
      },
    };
  </script>

  <title>Demo</title>
</head>

<body class="overflow-x-hidden bg-brandBg text-textDark flex flex-col items-center justify-start py-8 px-4">
  <h1 class="font-headland text-[1.4rem] font-medium mb-4">Scan de QR-code</h1>
  <button id="scanButton" class="bg-brandBlue hover:bg-brandBlueHover text-white rounded-md px-6 py-3 text-base font-inter mt-10 inline-flex items-center gap-2 transition-colors duration-200">
    Scan QR
    <span><strong>&gt;</strong></span>
  </button>
  <div id="reader" class="mt-10 hidden" style="width: min(480px, 92vw); aspect-ratio: 1/1; background:#000; border-radius: 12px; overflow:hidden"></div>
  <div id="scanError" class="mt-4 text-red-700 font-inter hidden"></div>
</body>

<script type="module">
  import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js';
  import { getDatabase, ref, set } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-database.js';

  const firebaseConfig = {
    databaseURL: "https://demoapp-6cc2a-default-rtdb.europe-west1.firebasedatabase.app/"
  };
  const app = initializeApp(firebaseConfig);
  const database = getDatabase(app);

  const scanButton = document.getElementById('scanButton');
  const reader = document.getElementById('reader');
  const scanError = document.getElementById('scanError');
  let html5QrCodeInstance = null;

  function showError(msg) {
    console.error(msg);
    scanError.textContent = typeof msg === 'string' ? msg : (msg?.message || JSON.stringify(msg));
    scanError.classList.remove('hidden');
  }

  async function startCamera() {
    try {
      if (!('isSecureContext' in window) || !window.isSecureContext) {
        showError('Camera requires HTTPS or localhost. Please serve via http://localhost or https.');
        return;
      }
      if (typeof Html5Qrcode === 'undefined') {
        showError('QR library not loaded.');
        return;
      }

      scanButton.classList.add('hidden');
      reader.classList.remove('hidden');
      scanError.classList.add('hidden');

      const cameras = await Html5Qrcode.getCameras();
      if (!cameras || cameras.length === 0) {
        showError('No cameras found');
        scanButton.classList.remove('hidden');
        return;
      }

      const picked = (cameras.find(c => /back|rear|environment/i.test(c.label))?.id) || cameras[0].id;

      html5QrCodeInstance = new Html5Qrcode('reader');
      await html5QrCodeInstance.start(
        { deviceId: { exact: picked } },
        { fps: 10, qrbox: 250, aspectRatio: 1.0 },
        async (decodedText) => {
          try { await html5QrCodeInstance.stop(); await html5QrCodeInstance.clear(); } catch {}
          reader.classList.add('hidden');
          set(ref(database, 'qrScanned'), decodedText).then(() => {
            console.log('Database updated with:', decodedText);
          }).catch((error) => {
            console.error('Database update failed:', error);
          });
          scanButton.classList.remove('hidden');
        },
        (err) => { /* frequent decode errors are expected; ignore */ }
      );
    } catch (e) {
      showError(e);
      try { if (html5QrCodeInstance) { await html5QrCodeInstance.stop(); await html5QrCodeInstance.clear(); } } catch {}
      reader.classList.add('hidden');
      scanButton.classList.remove('hidden');
    }
  }

  window.addEventListener('load', () => {
    scanButton.addEventListener('click', startCamera);
  });

  if ('serviceWorker' in navigator) {
    navigator.serviceWorker.register('sw.js');
  }
</script>
</html>
